<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" type="text/css" href="../css/api.css">
    <link rel="stylesheet" type="text/css" href="../css/font-icon.css">
    <link rel="stylesheet" type="text/css" href="../css/caicui.css">
    <script type="text/javascript" src="../script/api.js"></script>
    <script type="text/javascript" src="../script/zepto.js"></script>
    <title>在线课程-过期课程</title>
    <link rel="stylesheet" type="text/css" href="../css/col-lg.css">
  </head>
  <body>
    <ul id="content" class="course-pic-list overdue">
      <!--+lst-->
    </ul>
    <script id="tpl" type="text/x-dot-template">{{for(var p in it) { }}
          <li tapmode data-coursename="{{=it[p].courseName}}" data-chapterName="{{=it[p].chapterName}}">
            <div style="background-image:url({{=static_url+it[p].courseBkImage}})" class="cpl-head">
              <!--h4 {{=formatDate(it[p].expirationTime,'Y')+'-'+formatDate(it[p].expirationTime,'M')+'-'+formatDate(it[p].expirationTime,'D')}}  {{=formatDate(it[p].expirationTime,'h')+':'+formatDate(it[p].expirationTime,'m')}}-->
              <h4>{{=formatDate(it[p].expirationTime,'Y')+'-'+formatDate(it[p].expirationTime,'M')+'-'+formatDate(it[p].expirationTime,'D')}} 过期</h4>
            </div>
            <div class="cpl-main">
              <div class="li">
                <h3>{{=it[p].courseName}}</h3>{{if(!isEmpty(it[p].taskprogress)){ }}
                <p>上次学习到：{{=it[p].chapterName}}</p>{{ }else{ }}
                <p>开始学习此课程</p>{{ } }}
              </div>
              <div class="li pro-li">
                <div class="clearfix cla">
                  <div class="left"><i class="icon-play3"></i><span>{{=it[p].taskprogress?it[p].taskprogress:0}} / {{=it[p].taskTotal}}</span></div>
                  <div class="right"><i class="icon-pencil2"></i><span>{{=it[p].taskprogress?it[p].taskprogress:0}} / {{=it[p].taskTotal}}</span></div>
                </div>
                <div class="clearfix clb">学习进度：
                </div>
                <div class="progress-box">
                  <div class="progress">
                    <div min="{{=!isEmpty(it[p].taskprogress)?it[p].taskprogress:0}}" max="{{=!isEmpty(it[p].taskTotal)?it[p].taskTotal:0}}" class="progress-bar"></div>
                  </div>
                </div>
              </div>
              <div class="li lecturer">
                <dl><img src="{{=static_url+it[p].teacherImage}}" class="avatar">
                  <dt>{{=it[p].teacherName}}</dt>
                  <dd>{{=it[p].teacherHonor}}</dd>
                </dl>
              </div>
              <div class="li cpl-fool">
                <div onclick="openActivate('{{=it[p].courseName}}','{{=it[p].teacherName}}','{{=it[p].teacherHonor}}','{{=it[p].buyTime}}','{{=it[p].effectiveDay}}','{{=it[p].teacherImage}}','{{=it[p].isU}}','{{=it[p].courseId}}','{{=it[p].courseBkImage}}',this)" class="btn btn-o"><span>马上激活</span>
                  <div class="none data">{{=JSON.stringify(it[p])}}</div><i class="icon-lock-open"></i>
                </div>{{ if(!isEmpty(it[p].is_show)) { }}
                {{ if(it[p].isU==true){ }}
                <div tapmode onclick="renew()" class="btn btn-o"><span>申请重听</span><i class="icon-redo"></i></div>{{ } else{ }}
                <div tapmode onclick="api.toast({msg:'只有U+课程可以免费申请重听！',location:'middle'})" class="btn btn-o">申请重听</div>{{ } }}
                {{ } }}
              </div>
            </div>
          </li>{{ } }}
    </script>
    <script type="text/javascript" src="../script/comm.js"></script>
    <script type="text/javascript" src="../script/doT.min.js"></script>
    <script type="text/javascript" src="../script/caicui.js"></script>
    <script type="text/javascript" src="../script/db.js"></script>
    <script type="text/javascript" src="../script/saveTasksProgress.js"></script>
    <script type="text/javascript">
      var pageSize = 10;
      // 打开课程列表页面
      function openCourse(co, ch, su, ca, cn) {
      }
      function getData(page) {
      //                    var tpl = $('#tpl').html();
      //                    var content = doT.template(tpl);
      //                    if (page == 1) {
      //                        $('#content').html(content(data));
      //                    } else {
      //                        $('#content').append(content(data));
      //                    }
      //            progressBar();
      //                    return;
          var param = {};
          param.pageNo = page;
          param.pageSize = pageSize;
          param.token = $api.getStorage('token');
          if(page==1&&show_pro&&no_loaded){
              api.showProgress({
                  title:'加载中',
                  modal:false
              });
          }
          ajaxRequest('api/v2.1/learning/expirationcourse', 'get', param, function (ret, err) {//008.004.1 已过期课程
              if(show_pro&&no_loaded){
                  api.hideProgress();
              }
              if (err) {
                  api.toast({
                      msg: err.msg,
                      location: 'middle'
                  });
                  return false;
              }
              if (ret && ret.state == 'success') {
                  no_loaded=false;
                  total = ret.data.total;
                  var tpl = $('#tpl').html();
                  var content = doT.template(tpl);
                  var is_show;
                  var systemType = api.systemType;  // 比如: ios
                  if (systemType == 'ios') {
                      is_show = isEmpty(ret.data.courselist.isdisplay) ?  false :  ret.data.courselist.isdisplay;
                  } else {
                      is_show = true;
                  }
                  if (page == 1) {
                      if (isEmpty(ret.data) || total == 0) {
                          $('body').addClass('null');
                          return false;
                      }
                      $('body').removeClass('null');
                      for(var p in ret.data.courselist){
                          ret.data.courselist[p]['is_show']=is_show;
                      }
                      $('#content').html(content(ret.data.courselist));
                  } else {
                      for (var p in ret.data.courselist) {
                          ret.data.courselist[p]['is_show'] = is_show;
                      }
                      $('#content').append(content(ret.data.courselist));
                  }
                  progressBar();
                  api.parseTapmode();
      //                    progressBar();
              } else {
                  /*api.toast({
                      msg: ret.msg,
                      location: 'middle'
                  });*/
              }
          });
      }
      var total = 0;
      var no_loaded=true;
      apiready = function () {
          getData(1);
          var currentPage = 1;
          api.setRefreshHeaderInfo({
              visible: true,
              loadingImg: 'widget://image/arrow-down-o.png',
              bgColor: '#f3f3f3',
              textColor: '#787b7c',
              textDown: '下拉更多',
              textUp: '松开刷新',
              showTime: false
          }, function (ret, err) {
              getData(1);
              currentPage = 1;
          });
          //滚动到底部
          api.addEventListener({
              name: 'scrolltobottom'
          }, function (ret, err) {
              if (currentPage < Math.ceil(total / pageSize)) {
                  currentPage++;
                  getData(currentPage);
              }
          });
      };
      function renew() {
          var systemType = api.systemType;
          if (systemType == 'ios') {
             api.openApp({
                  iosUrl: 'http://www.caicui.com/mc/examReport/add?token=' + $api.getStorage('token')
              });
          } else {
              api.openApp({
                  androidPkg: 'android.intent.action.VIEW',
                  mimeType: 'text/html',
                  uri: 'http://www.caicui.com/mc/examReport/add?token=' + $api.getStorage('token')
              }, function (ret, err) {
              });
          }
      }
    </script>
  </body>
</html>